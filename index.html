<html>
<script src='https://d3js.org/d3.v5.min.js'></script>
<style> 
	rect {fill: lightblue; stroke: black;}
</style>
<style>
	#tooltip {
		opacity: 0;
		position: absolute;
		text-align: center;
		width: 100px;
		height: 112px;
		background: white;
		border: 0px;
		font-size: 12;
		padding:5px;
	}
</style>
<body>

<svg width=800 height=800></svg>
<div id="tooltip"></div>
<script>
var diseases = ['ALZ','CAN','CLD','DIA','HOM','HTD','HYP','INJ','LIV','NEP','OTH','PNF','STK','SUI']

async function init() {

	var csv = await d3.csv("https://ShivanVipani.github.io/disease.csv");
	var race_csv = await d3.csv("https://ShivanVipani.github.io/race.csv");
	var data = {}
	for (var i = 0; i < csv.length; i++) {
		if (csv[i]['County'] === 'Alameda') {
			var year = parseInt(csv[i]['year'])
			if (csv[i]['leadingcause'] in data) {
				data[csv[i]['leadingcause']][year-2017] += parseInt(csv[i]['Count']) || 0
			}
			else {
				data[csv[i]['leadingcause']] = [0,0,0,0]
				data[csv[i]['leadingcause']][year-2017] += parseInt(csv[i]['Count']) || 0
			}
		}
	}
	var race_data = {}
	for (var i = 0; i < race_csv.length; i++) {
		if (race_csv[i]['County'] === 'Alameda') {
			var year = parseInt(race_csv[i]['year'])
			if (race_csv[i]['leadingcause'] in race_data) {
				if (race_csv[i]['Race_Ethnicity'] in race_data[race_csv[i]['leadingcause']]) {
					race_data[race_csv[i]['leadingcause']][race_csv[i]['Race_Ethnicity']][year-2017] += parseInt(race_csv[i]['Count']) || 0
				}
				else {
					race_data[race_csv[i]['leadingcause']][race_csv[i]['Race_Ethnicity']] = [0,0,0,0]
					race_data[race_csv[i]['leadingcause']][race_csv[i]['Race_Ethnicity']][year-2017] += parseInt(race_csv[i]['Count']) || 0
				}
			}
			else {
				race_data[race_csv[i]['leadingcause']] = {}
				//[0,0,0,0]
				if (race_csv[i]['Race_Ethnicity'] in race_data[race_csv[i]['leadingcause']]) {
					race_data[race_csv[i]['leadingcause']][race_csv[i]['Race_Ethnicity']][year-2017] += parseInt(race_csv[i]['Count']) || 0
				}
				else {
					race_data[race_csv[i]['leadingcause']][race_csv[i]['Race_Ethnicity']] = [0,0,0,0]
					race_data[race_csv[i]['leadingcause']][race_csv[i]['Race_Ethnicity']][year-2017] += parseInt(race_csv[i]['Count']) || 0
				}
			}
		}
	}
	console.log(data)
	console.log(race_data)
	return data, race_data
}
	var data, race_data = init()

	var svg = d3.select("svg");
	svg.append("text")
       .attr("transform", "translate(100,0)")
       .attr("x", 50)
       .attr("y", 20)
       .attr("font-size", "24px")
       .text("Alameda County Deaths by Cause")

	var margin = 50;
	var width = svg.attr("width") - 2*margin;
	var height = svg.attr("height") - 2*margin;
	var x = d3.scaleBand().domain(diseases).range([0,width]);
	var y = d3.scaleLinear().domain([0,2305]).range([height,0]);
	var tooltip = d3.select("#tooltip");

	d3.select("svg").append("g").attr("transform", "translate("+margin+","+margin+")").call(d3.axisLeft(y))
	.append("text")
         .attr("transform", "rotate(-90)")
         .attr("x", 6)
         .attr("y", 6)
         .attr("dy", "-5.1em")
         .attr("text-anchor", "end")
         .attr("stroke", "black")
         .text("Cases");

	d3.select("svg").append("g").attr("transform","translate(" +margin+ ","+ (height+margin)+")")
	.call(d3.axisBottom(x))
	.append("text")
         .attr("y", 30)
         .attr("x", width)
         .attr("text-anchor", "end")
         .attr("stroke", "black")
         .text("Disease");

    function update(data, race_data, index) {
    	var g = svg.append("g").attr("transform", "translate("+margin+","+margin+")");
		g.selectAll("rect").data(d3.entries(data))
		.enter().append("rect")
		.transition()
    	.duration(1000)
		.attr("x", function(d, i) { return x(diseases[i]); })
		.attr("y", function(d) { return y(d['value'][index]); })
		.attr("width", x.bandwidth())
		.attr("height", function(d) {return (height - y(d['value'][index])); })
		.on("mouseover", function(d, i) {tooltip.style("opacity", .9)
			.style("left", d3.event.pageX + "px")		
	        .style("top", (d3.event.pageY - 28) + "px")
	        .html("Hispanic: " + race_data[diseases[i]]['Hispanic'][index] 
	        	+ "<br>Asian: " + race_data[diseases[i]]['Non-Hispanic Asian'][index] 
	        	+ "<br>Black: " + race_data[diseases[i]]['Non-Hispanic Black/African-American'][index] 
	        	+ "<br>Multi-Racial: " + race_data[diseases[i]]['Non-Hispanic Multi-Race'][index] 
	        	+ "<br>Native: " + race_data[diseases[i]]['Non-Hispanic Native American/Alaskan Native'][index] 
	        	+ "<br>Other: " + race_data[diseases[i]]['Non-Hispanic Other/Unknown'][index] 
	        	+ "<br>Pacific Islander: " + race_data[diseases[i]]['Non-Hispanic Pacific Islander/Native Hawaiian'][index] 
	        	+ "<br>White: " + race_data[diseases[i]]['Non-Hispanic White'][index] 
	        	);})	
	    .on("mouseout", function(d) {tooltip.style("opacity", 0);	})
	    console.log("Update" + index)
	}

	update(0)



</script>
<button onclick="update(data, race_data, 0)">2017</button>
<button onclick="update(data, race_data, 1)">2018</button>
<button onclick="update(data, race_data, 2)">2019</button>
<button onclick="update(data, race_data, 3)">2020</button>
</body>
</html>
